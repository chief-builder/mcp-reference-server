<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Code Review: Authentication &amp; Security Domain | MCP Reference Server</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Code Review: Authentication &amp; Security Domain" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A learning project implementing the Model Context Protocol (MCP) 2025-11-25 specification" />
<meta property="og:description" content="A learning project implementing the Model Context Protocol (MCP) 2025-11-25 specification" />
<link rel="canonical" href="http://localhost:4000/code_review_results/01-auth-security.html" />
<meta property="og:url" content="http://localhost:4000/code_review_results/01-auth-security.html" />
<meta property="og:site_name" content="MCP Reference Server" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Code Review: Authentication &amp; Security Domain" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"A learning project implementing the Model Context Protocol (MCP) 2025-11-25 specification","headline":"Code Review: Authentication &amp; Security Domain","url":"http://localhost:4000/code_review_results/01-auth-security.html"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=4084654cb939e8940665a91c4c56b28d8f437143">
    <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
    <![endif]-->
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->

  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1><a href="http://localhost:4000/">MCP Reference Server</a></h1>

        

        <p>A learning project implementing the Model Context Protocol (MCP) 2025-11-25 specification</p>

        
        <p class="view"><a href="https://github.com/chiefbuilder/mcp-reference-server">View the Project on GitHub <small>chiefbuilder/mcp-reference-server</small></a></p>
        

        

        
      </header>
      <section>

      <h1 id="code-review-authentication--security-domain">Code Review: Authentication &amp; Security Domain</h1>

<p><strong>Review Date:</strong> 2026-01-18
<strong>Files Reviewed:</strong> 7
<strong>Total Lines:</strong> ~3,000</p>

<hr />

<h2 id="files-reviewed">Files Reviewed</h2>

<table>
  <thead>
    <tr>
      <th>File</th>
      <th>Lines</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">src/auth/oauth.ts</code></td>
      <td>766</td>
      <td>OAuth 2.1 Authorization Code flow with PKCE</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">src/auth/tokens.ts</code></td>
      <td>680</td>
      <td>Token storage, validation, refresh, introspection</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">src/auth/scopes.ts</code></td>
      <td>514</td>
      <td>MCP scope definitions and validation</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">src/auth/discovery.ts</code></td>
      <td>301</td>
      <td>OAuth metadata discovery (RFC 8414/9728)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">src/auth/pkce.ts</code></td>
      <td>204</td>
      <td>PKCE implementation (RFC 7636)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">src/auth/m2m.ts</code></td>
      <td>18</td>
      <td>M2M auth re-export</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">src/extensions/oauth-m2m.ts</code></td>
      <td>516</td>
      <td>Client Credentials flow</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="executive-summary">Executive Summary</h2>

<p>The authentication implementation is generally well-structured with good OAuth 2.1 compliance. However, there are several security concerns that should be addressed, particularly around JWT verification, timing attacks, and race conditions in token refresh.</p>

<hr />

<h2 id="issues-by-file">Issues by File</h2>

<h3 id="1-srcauthoauthts">1. <code class="language-plaintext highlighter-rouge">src/auth/oauth.ts</code></h3>

<h4 id="high---timing-attack-in-state-validation-lines-241-257">HIGH - Timing Attack in State Validation (Lines 241-257)</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">function</span> <span class="nx">validateState</span><span class="p">(</span><span class="nx">received</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">expected</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nx">boolean</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">received</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">expected</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">received</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="nx">expected</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>  <span class="c1">// Early return leaks length information</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>Issue:</strong> The early return on length mismatch leaks timing information. An attacker could determine the expected state length through timing analysis.</p>

<p><strong>Recommendation:</strong> Use constant-time comparison for the entire operation, including length check.</p>

<h4 id="medium---no-token-response-body-error-handling-lines-572-573">MEDIUM - No Token Response Body Error Handling (Lines 572-573)</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">responseBody</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
</code></pre></div></div>

<p><strong>Issue:</strong> If the response body is not valid JSON, this throws an unhandled exception.</p>

<p><strong>Recommendation:</strong> Wrap in try-catch with appropriate error handling.</p>

<h4 id="medium---client-secret-in-request-body-lines-503-505">MEDIUM - Client Secret in Request Body (Lines 503-505)</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">clientSecret</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">body</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">client_secret</span><span class="dl">'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">clientSecret</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>Issue:</strong> Client secret sent in request body is less secure than HTTP Basic authentication.</p>

<p><strong>Recommendation:</strong> Prioritize <code class="language-plaintext highlighter-rouge">client_secret_basic</code> method.</p>

<h4 id="low---session-expiration-default">LOW - Session Expiration Default</h4>

<p>The 10-minute default is reasonable but should be documented that longer sessions increase CSRF attack window.</p>

<h4 id="low---missing-resource-validation-lines-380-384">LOW - Missing Resource Validation (Lines 380-384)</h4>

<p>Resource URLs are not validated beyond Zod’s URL check. Malicious resource indicators could be used for SSRF attacks.</p>

<hr />

<h3 id="2-srcauthtokensts">2. <code class="language-plaintext highlighter-rouge">src/auth/tokens.ts</code></h3>

<h4 id="high---no-jwt-signature-verification-lines-379-445">HIGH - No JWT Signature Verification (Lines 379-445)</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">validateJwtFormat</span><span class="p">(</span><span class="nx">token</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">options</span><span class="p">?:</span> <span class="nx">TokenValidationOptions</span><span class="p">):</span> <span class="nx">TokenPayload</span> <span class="p">{</span>
  <span class="c1">// Note: This does NOT verify the signature. For production use,</span>
  <span class="c1">// signature verification should be done using the authorization</span>
  <span class="c1">// server's public keys.</span>
</code></pre></div></div>

<p><strong>Issue:</strong> Without signature verification, attackers could forge tokens with arbitrary claims.</p>

<p><strong>Recommendation:</strong> Implement signature verification using <code class="language-plaintext highlighter-rouge">jose</code> library against authorization server’s JWKS.</p>

<h4 id="high---race-condition-in-token-refresh-lines-543-556">HIGH - Race Condition in Token Refresh (Lines 543-556)</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">existingPromise</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">refreshPromises</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">existingPromise</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">existingPromise</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">refreshPromise</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">performRefresh</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span>
<span class="k">this</span><span class="p">.</span><span class="nx">refreshPromises</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">refreshPromise</span><span class="p">);</span>
</code></pre></div></div>

<p><strong>Issue:</strong> TOCTOU race condition between checking and setting the promise. Concurrent calls could start multiple refresh operations.</p>

<p><strong>Recommendation:</strong> Use a proper async mutex/lock pattern.</p>

<h4 id="medium---introspection-credentials-in-memory-lines-476-481">MEDIUM - Introspection Credentials in Memory (Lines 476-481)</h4>

<p>Base64 encoded credentials remain in memory after use.</p>

<p><strong>Recommendation:</strong> Consider clearing sensitive data after use.</p>

<h4 id="medium---default-1-hour-token-expiry">MEDIUM - Default 1-Hour Token Expiry</h4>

<p>If the authorization server doesn’t specify <code class="language-plaintext highlighter-rouge">expires_in</code>, the 1-hour default could cache tokens longer than intended.</p>

<h4 id="low---unsafe-json-parsing-lines-496-497">LOW - Unsafe JSON Parsing (Lines 496-497)</h4>

<p>Should handle JSON parse errors gracefully.</p>

<hr />

<h3 id="3-srcauthscopests">3. <code class="language-plaintext highlighter-rouge">src/auth/scopes.ts</code></h3>

<h4 id="medium---scope-injection-via-tool-names-lines-199-201">MEDIUM - Scope Injection via Tool Names (Lines 199-201)</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">function</span> <span class="nx">buildToolScope</span><span class="p">(</span><span class="nx">toolName</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="kr">string</span> <span class="p">{</span>
  <span class="k">return</span> <span class="s2">`</span><span class="p">${</span><span class="nx">TOOL_SCOPE_PREFIX</span><span class="p">}${</span><span class="nx">toolName</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>Issue:</strong> No validation on tool names. A malicious tool name like <code class="language-plaintext highlighter-rouge">../admin</code> could lead to unexpected scope matching.</p>

<p><strong>Recommendation:</strong> Validate tool names against a safe pattern (alphanumeric, underscore, hyphen).</p>

<h4 id="low---no-scope-string-sanitization-lines-164-169">LOW - No Scope String Sanitization (Lines 164-169)</h4>

<p>Scope string is only split on whitespace. Special characters could cause issues in different contexts.</p>

<h4 id="low---missing-input-validation-on-custom-method-scopes">LOW - Missing Input Validation on Custom Method Scopes</h4>

<p>Custom method scopes from configuration are not validated.</p>

<hr />

<h3 id="4-srcauthdiscoveryts">4. <code class="language-plaintext highlighter-rouge">src/auth/discovery.ts</code></h3>

<h4 id="medium---environment-variable-injection-lines-122-132">MEDIUM - Environment Variable Injection (Lines 122-132)</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">resourceUrl</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">MCP_RESOURCE_URL</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">authServersEnv</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">MCP_AUTH_SERVERS</span><span class="p">;</span>
</code></pre></div></div>

<p><strong>Issue:</strong> Environment variables used directly without URL validation could cause SSRF or header injection.</p>

<p><strong>Recommendation:</strong> Add URL validation for environment-sourced values.</p>

<h4 id="medium---potential-header-injection-lines-222-245">MEDIUM - Potential Header Injection (Lines 222-245)</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">errorDescription</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">parts</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">`error_description="</span><span class="p">${</span><span class="nx">options</span><span class="p">.</span><span class="nx">errorDescription</span><span class="p">}</span><span class="s2">"`</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>Issue:</strong> <code class="language-plaintext highlighter-rouge">errorDescription</code> inserted directly into header could enable header injection if it contains quotes or newlines.</p>

<p><strong>Recommendation:</strong> Escape or reject special characters.</p>

<h4 id="low---caching-without-validation">LOW - Caching Without Validation</h4>

<p>1-hour cache could serve stale metadata. Consider adding <code class="language-plaintext highlighter-rouge">must-revalidate</code>.</p>

<hr />

<h3 id="5-srcauthpkcets">5. <code class="language-plaintext highlighter-rouge">src/auth/pkce.ts</code></h3>

<h4 id="medium---modulo-bias-in-code-verifier-generation-lines-78-90">MEDIUM - Modulo Bias in Code Verifier Generation (Lines 78-90)</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">charsetLength</span> <span class="o">=</span> <span class="nx">PKCE_VERIFIER_CHARSET</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>  <span class="c1">// 66 characters</span>
<span class="kd">const</span> <span class="nx">randomIndex</span> <span class="o">=</span> <span class="nx">randomByte</span> <span class="o">%</span> <span class="nx">charsetLength</span><span class="p">;</span>  <span class="c1">// 256 % 66 = bias</span>
</code></pre></div></div>

<p><strong>Issue:</strong> Using <code class="language-plaintext highlighter-rouge">% 66</code> on a byte (0-255) creates modulo bias. Characters at indices 0-57 are slightly more likely than indices 58-65.</p>

<p><strong>Recommendation:</strong> Use rejection sampling or a library for unbiased random selection.</p>

<h4 id="low---timing-safe-comparison-length-leak-lines-172-186">LOW - Timing-Safe Comparison Length Leak (Lines 172-186)</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>  <span class="c1">// Early return leaks length</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>Issue:</strong> Same length-leak issue as in oauth.ts.</p>

<p><strong>Recommendation:</strong> Use Node.js built-in <code class="language-plaintext highlighter-rouge">crypto.timingSafeEqual</code> after padding to equal lengths.</p>

<h4 id="low---synchronous-hash-computation">LOW - Synchronous Hash Computation</h4>

<p>While fine for small inputs, could block event loop with very long verifiers.</p>

<hr />

<h3 id="6-srcauthm2mts">6. <code class="language-plaintext highlighter-rouge">src/auth/m2m.ts</code></h3>

<h4 id="low---tight-coupling">LOW - Tight Coupling</h4>

<p>Purely a re-export, creating unnecessary dependency chain. Consider consolidation.</p>

<hr />

<h3 id="7-srcextensionsoauth-m2mts">7. <code class="language-plaintext highlighter-rouge">src/extensions/oauth-m2m.ts</code></h3>

<h4 id="high---client-secret-logged-in-error-handler-lines-461-467">HIGH - Client Secret Logged in Error Handler (Lines 461-467)</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">safeConfig</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">getConfig</span><span class="p">();</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span>
    <span class="s2">`M2M OAuth initialization failed for client </span><span class="p">${</span><span class="nx">safeConfig</span><span class="p">.</span><span class="nx">clientId</span><span class="p">}</span><span class="s2">...`</span><span class="p">,</span>
    <span class="nx">error</span> <span class="k">instanceof</span> <span class="nb">Error</span> <span class="p">?</span> <span class="nx">error</span><span class="p">.</span><span class="nx">message</span> <span class="p">:</span> <span class="dl">'</span><span class="s1">Unknown error</span><span class="dl">'</span>
  <span class="p">);</span>
</code></pre></div></div>

<p><strong>Issue:</strong> While <code class="language-plaintext highlighter-rouge">safeConfig</code> excludes the secret, OAuth error messages from providers may include credential hints.</p>

<p><strong>Recommendation:</strong> Sanitize error messages before logging.</p>

<h4 id="medium---race-condition-in-token-caching-lines-228-238">MEDIUM - Race Condition in Token Caching (Lines 228-238)</h4>

<p>Same TOCTOU issue as in tokens.ts.</p>

<h4 id="medium---credentials-persisted-in-memory">MEDIUM - Credentials Persisted in Memory</h4>

<p>Base64-encoded credentials remain in string pool.</p>

<h4 id="low---extension-settings-expose-token-endpoint">LOW - Extension Settings Expose Token Endpoint</h4>

<p>Could aid attackers in identifying authorization server.</p>

<hr />

<h2 id="summary">Summary</h2>

<table>
  <thead>
    <tr>
      <th>Severity</th>
      <th>Count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Critical</td>
      <td>0</td>
    </tr>
    <tr>
      <td>High</td>
      <td>4</td>
    </tr>
    <tr>
      <td>Medium</td>
      <td>9</td>
    </tr>
    <tr>
      <td>Low</td>
      <td>8</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="recommendations">Recommendations</h2>

<h3 id="immediate-actions">Immediate Actions</h3>

<ol>
  <li><strong>Implement JWT signature verification</strong> using <code class="language-plaintext highlighter-rouge">jose</code> library</li>
  <li><strong>Fix timing-safe comparisons</strong> using <code class="language-plaintext highlighter-rouge">crypto.timingSafeEqual</code> with length padding</li>
  <li><strong>Add mutex/lock for token refresh</strong> to prevent race conditions</li>
  <li><strong>Fix modulo bias in PKCE</strong> using rejection sampling</li>
</ol>

<h3 id="short-term">Short-term</h3>

<ol>
  <li>Sanitize header values to prevent injection</li>
  <li>Validate environment-sourced URLs</li>
  <li>Add tool name validation in scope building</li>
  <li>Wrap JSON parsing in try-catch</li>
</ol>

<h3 id="code-quality">Code Quality</h3>

<ol>
  <li>Document session expiration security implications</li>
  <li>Consider consolidating m2m.ts re-export</li>
</ol>


<hr>

<div class="nav-footer">
  <p><strong>Navigation:</strong>
    <a href="/">Home</a> |
    <a href="/getting-started/installation">Getting Started</a> |
    <a href="/guides/protocol">Guides</a> |
    <a href="/api/protocol">API Reference</a> |
    <a href="/examples/stdio-server">Examples</a> |
    <a href="/reference/environment">Reference</a>
  </p>
</div>



      </section>
      <footer>
        
        <p>This project is maintained by <a href="https://github.com/chiefbuilder">chiefbuilder</a></p>
        
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="/assets/js/scale.fix.js"></script>
  </body>
</html>
